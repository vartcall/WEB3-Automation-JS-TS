# 🧠 Урок 01: Provider

[← Вернуться к основному README](../../README.md)

## 🔗 ЗАДАЧА

Научиться подключаться к блокчейн-провайдеру через **Ethers.js** и понять, как устроено взаимодействие с Ethereum на низком уровне.

---

## 📚 Что такое Provider?

**Provider** - мост между твоим приложением и блокчейном. Он позволяет:

- читать данные из блокчейна (балансы, блоки, события)
- подписываться на обновления
- отправлять транзакции (в связке с Wallet)

В Ethers.js используется класс `ethers.JsonRpcProvider` для подключения к Ethereum через RPC (Remote Procedure Call).

---

## 📦 Типы провайдеров в Ethers.js (v6, 2025)

| Тип провайдера       | Описание                                                                                |
| -------------------- | --------------------------------------------------------------------------------------- |
| `JsonRpcProvider`    | Стандартный RPC-провайдер. Подключается к Infura, Alchemy, локальному узлу и др.        |
| `WebSocketProvider`  | Подключение через WebSocket. Подходит для подписок на события контрактов.               |
| `InfuraProvider`     | Упрощённое подключение к Infura. Требуется `projectId` и (опционально) `projectSecret`. |
| `AlchemyProvider`    | Быстрая интеграция с Alchemy. Аналогично InfuraProvider.                                |
| `CloudflareProvider` | Бесплатный провайдер **только для Ethereum mainnet**. Без API ключа.                    |
| `FallbackProvider`   | Объединяет несколько провайдеров с автоматическим переключением при сбое.               |
| `AnkrProvider`       | Публичный провайдер от Ankr. Не требует ключа. Подходит для быстрого старта.            |

---

### ⚙️ Дополнительно

- В Ethers.js v6 используется модульная архитектура: можно подключать транспорты отдельно (`ethers.InfuraTransport`, `ethers.JsonRpcProvider` и т.д.).
- Для большинства задач подойдёт `ethers.getDefaultProvider(network)` — он автоматически использует FallbackProvider с несколькими провайдерами.
- `FallbackProvider` позволяет задавать веса и таймауты для надёжности.

---

🔗 Документация: [https://docs.ethers.org/v6/](https://docs.ethers.org/v6/)

## 🧠 Как выбрать RPC-провайдера?

- **Infura** – удобно, стабильно, бесплатно до лимита
- **Alchemy** – мощные DevTools + хорошие лимиты
- **QuickNode** – быстрый, но платный
- **Local RPC** – если разворачиваешь ноду сам (`geth`, `anvil`, `hardhat`)

---

## 🧭 Частые ошибки при работе с провайдерами

| Ошибка                                | Причина и решение                                                            |
| ------------------------------------- | ---------------------------------------------------------------------------- |
| `Missing API key` или `403 Forbidden` | Неверный или отсутствующий API ключ. Проверь `.env` и URL                    |
| `Cannot read properties of undefined` | Забыл `dotenv.config()` или переменная окружения пустая                      |
| `Network Error` или `ECONNREFUSED`    | RPC-сервер не отвечает. Проверь URL или замени на другого провайдера         |
| `Timeout exceeded`                    | Нестабильное соединение. Используй `FallbackProvider` для отказоустойчивости |

---

## Рекомендации по архитектуре

- Хранить RPC-ключи отдельно в `.env`, никогда не комить их в Git
- Выделить `provider.ts` как модуль с конфигурацией (особенно если у тебя несколько сетей)
- При необходимости подписок использовать WebSocket-провайдер отдельно от JsonRpc
- Если писать бота - используем `FallbackProvider` с несколькими источниками

## 🧰 Что можно делать с провайдером?

```ts
// Базовые методы:
await provider.getBlockNumber(); // текущий номер блока
await provider.getNetwork(); // информация о сети
await provider.getBalance(address); // баланс в wei
await provider.getGasPrice(); // цена газа
await provider.getBlock("latest"); // данные последнего блока
await provider.getTransaction(hash); // информация о транзакции
await provider.getLogs(filter); // фильтрация событий
```

### 🧪 Примеры использования провайдера

```ts
import { JsonRpcProvider } from "ethers";

const provider = new JsonRpcProvider("https://mainnet.infura.io/v3/INFURA_KEY");

const main = async () => {
  const blockNumber = await provider.getBlockNumber();
  console.log("Текущий номер блока:", blockNumber);
};

main();
```

## 🛠 Пример визуального потока provider

                ┌──────────────┐
                │   Программа  │
                └──────┬───────┘
                       │ вызов метода (например, getBalance)
                       ▼
                ┌──────────────┐
                │   Provider   │  (ethers.js)
                └──────┬───────┘
                       │ формирует JSON-RPC
                       ▼
             ┌─────────────────────┐
             │ Ethereum-нода (RPC) │ ← Infura / Alchemy / Hardhat / Geth
             └─────────────────────┘
                       ▲
                       │ ответ JSON
                       ▼
                ┌──────────────┐
                │  Provider    │
                └──────┬───────┘
                       │ преобразование результата
                       ▼
                ┌──────────────┐
                │   Программа  │
                └──────────────┘

---

## 🛠 Что дальше?

мы разобрали:

- Что такое провайдер и зачем он нужен
- Какие типы провайдеров бывают в Ethers.js
- Как выбирать RPC и подключаться к Ethereum
- Какие ошибки могут возникнуть и как их избегать
- Базовые методы для чтения данных из блокчейна

---

## 🧪 Дальше - технический разбор

В файле [`01-provider.ts`](./01-provider.ts) мы **технически разберём работу провайдера** и пошагово выполним:

1. Подключение к сети через `JsonRpcProvider`
2. Получение номера блока и информации о сети
3. Получение цены газа
4. Получение баланса адреса
5. Использование `.env` и безопасная конфигурация

Это будет **не полноценная практика**, а **разогрев** и подготовка к следующему уроку, где мы начнём взаимодействовать с кошельками и транзакциями.

---
