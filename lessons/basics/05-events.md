# üëª –£—Ä–æ–∫ 05: –°–æ–±—ã—Ç–∏—è –≤ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö

[‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É README](../../README.md)

## üîó –ó–ê–î–ê–ß–ê

–ù–∞—É—á–∏—Ç—å—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å **—Å–æ–±—ã—Ç–∏—è (events)**, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∏–∑ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è `ethers.js`.

---

## üéØ –ß–¢–û –¢–ê–ö–û–ï —Å–æ–±—ã—Ç–∏—è?

–°–æ–±—ã—Ç–∏—è - –º–µ—Ö–∞–Ω–∏–∑–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö. –û–Ω–∏:

- –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–æ–∫—á–µ–π–Ω–∞
- –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, —Ç–æ–ª—å–∫–æ –∏–∑ –≤–Ω–µ)
- –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –æ —Ç–æ–º, —á—Ç–æ —á—Ç–æ-—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ

–ü—Ä–∏–º–µ—Ä—ã:

- `Transfer(address indexed from, address indexed to, uint amount)` - –≤ —Ç–æ–∫–µ–Ω–∞—Ö
- `Deposit(address user, uint amount)` - –≤ DeFi-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞—Ö

---

## üß© –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è?

- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Ç–æ–∫–µ–Ω–æ–≤, NFT –∏ —Ç.–¥.)
- –í –ª–æ–≥–∏–∫–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å, –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- –î–ª—è —Ä–∞–±–æ—Ç—ã —Å `The Graph`, –ª–æ–≥–µ—Ä–∞–º–∏, –±—ç–∫–µ–Ω–¥–∞–º–∏

---

## üîê –ö–∞–∫ —Å–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏—è —Å ethers.js

–ï—Å—Ç—å –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞:

### 1. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)**

```ts
contract.on("Transfer", (from, to, amount, event) => {
  console.log(`üì° –ü–µ—Ä–µ–≤–æ–¥: ${from} ‚Üí ${to}, —Å—É–º–º–∞: ${amount.toString()}`);
});
```

### 2. **–ß—Ç–µ–Ω–∏–µ –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–æ–±—ã—Ç–∏–π (–∏—Å—Ç–æ—Ä–∏—è –±–ª–æ–∫–æ–≤)**

–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –Ω–µ "—Å–ª—É—à–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏", –∞ –ø–æ–ª—É—á–∏—Ç—å **–≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥**. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `contract.queryFilter(...)`.

```ts
// –§–∏–ª—å—Ç—Ä –≤—Å–µ—Ö Transfer —Å–æ–±—ã—Ç–∏–π –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É

const transferEvent = contract.getEvent("Transfer");
const filter = transferEvent.filter("0xFromAddress", null);
const events = await contract.queryFilter(filter, fromBlock, toBlock);

for (const event of events) {
  const { args, transactionHash } = event;
  console.log(
    `üìú –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥: ${args?.from} ‚Üí ${
      args?.to
    }, —Å—É–º–º–∞: ${args?.amount.toString()}`
  );
  console.log(
    `üîó –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: https://sepolia.etherscan.io/tx/${transactionHash}`
  );
}
```

---

### 3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–±—ã—Ç–∏–π**

–ï—Å–ª–∏ —Ç—ã –∏—â–µ—à—å —Å–æ–±—ã—Ç–∏—è –∏–∑ –±–æ–ª—å—à–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –±–ª–æ–∫–æ–≤, –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```ts
const logs = await contract.queryFilter(filter, fromBlock, toBlock);

// –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–±—ã—Ç–∏–π
const lastEvents = logs.slice(-5);
```

---

### 4. üéØ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `indexed` –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º

–ú–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä—è–≤–ª–µ–Ω—ã –∫–∞–∫ `indexed` –≤ —Å–∞–º–æ–º —Å–æ–±—ã—Ç–∏–∏:

```solidity
event Transfer(address indexed from, address indexed to, uint256 amount);
```

```ts
const transferEvent = contract.getEvent("Transfer");
const filter = transferEvent.filter("0xFromAddress", null);
const events = await contract.queryFilter(filter, fromBlock, toBlock);

for (const event of events) {
  console.log(
    `üéØ –§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: ${event.args?.from} ‚Üí ${event.args?.to}`
  );
}
```

> ‚ùóÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑ `indexed` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `amount`) —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è ‚Äî –∏—Ö –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ `event.args`.

---

### 5. üö´ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ

–ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ —Å–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ `.off()`:

```ts
function handleTransfer(from, to, amount) {
  console.log(`‚û°Ô∏è ${from} ‚Üí ${to}, —Å—É–º–º–∞: ${amount.toString()}`);
}

contract.on("Transfer", handleTransfer); // –ü–æ–¥–ø–∏—Å–∫–∞
contract.off("Transfer", handleTransfer); // –£–¥–∞–ª–µ–Ω–∏–µ
```

---

### 6. üîÇ –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (`once`)

–ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø–æ–π–º–∞—Ç—å **—Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ**, –∏—Å–ø–æ–ª—å–∑—É–π `.once()`:

```ts
contract.once("Transfer", (from, to, amount) => {
  console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω –ø–µ—Ä–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥: ${from} ‚Üí ${to}`);
});
```

---

### 7. üé® –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –º–æ–≥—É—Ç –æ–±—ä—è–≤–ª—è—Ç—å —Å–≤–æ–∏ —Å–æ–±—ã—Ç–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```solidity
event NFTMinted(address indexed user, uint256 tokenId, string uri);
```

–°–ª—É—à–∞—Ç—å —Ç–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –º–æ–∂–Ω–æ —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ:

```ts
contract.on("NFTMinted", (user, tokenId, uri) => {
  console.log(`üñº NFT #${tokenId} —Å–º–∏–Ω—á–µ–Ω –¥–ª—è ${user}`);
  console.log(`üîó URI: ${uri}`);
});
```

> üîç –ê—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, –∫–∞–∫ –≤ Solidity, –∏ —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `event.args`.

---

## üõ† –î–ê–õ–ï–ï - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ

–í —Ñ–∞–π–ª–µ [`05-events.ts`](./05-events.ts) –º—ã:

- –ü–æ–¥–∫–ª—é—á–∏–º WebSocket-–ø—Ä–æ–≤–∞–π–¥–µ—Ä
- –ü–æ–¥–ø–∏—à–µ–º—Å—è –Ω–∞ `Transfer(...)` —á–µ—Ä–µ–∑ `.on(...)`
- –ü—Ä–æ—á–∏—Ç–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ `queryFilter(...)`
- –õ–æ–≥–∏—á–µ—Å–∫–∏ —Å–æ–µ–¥–∏–Ω–∏–º –≤—Å—ë –≤ –æ–¥–Ω–æ–º —É–¥–æ–±–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ

> –≠—Ç–æ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–µ–Ω–¥-–±–æ—Ç–æ–≤, realtime-UI, –∞–ª–µ—Ä—Ç–æ–≤, –ª–æ–≥–µ—Ä–æ–≤ –∏ –≤—Å–µ–≥–æ, —á—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ —Å–µ—Ç–∏.
